{% extends 'base.html' %}
<!--title-->
{% block title %} - {{page_title}}{% endblock title %}
<!--static-->
{% load static %}
<!--content-->
{% block content %}
<div class="pricing-header p-3 pb-md-4 mx-auto text-center">
  <h1 class="display-4 fw-normal">Polling Units Results</h1>
  <form action="" method="post">
    {% csrf_token %}
    <div class="row">
      <div class="col-md-12">
        <div class="input-group has-validation">
          <span class="input-group-text"><i class="fas fa-search"></i></span>
          <input
            type="search"
            class="form-control"
            id="polling_unit_number"
            name="unit_number"
            placeholder="Polling unit unique ID"
            value="15"
          />
        </div>
      </div>
    </div>
  </form>
</div>
<main>
  <div id="spinningLoader" class="text-center mt-5">
    <span
      class="spinner-border spinner-border-md text-success"
      role="status"
      aria-hidden="true"
    ></span>
    Loading...
  </div>
  <div class="table-responsive">
    <h3 class="text-center" id="polling_unit_info_header">
      Polling unit information
    </h3>
    <table class="table table-hover" id="polling_unit_info_table">
      <thead>
        <tr>
          <th>#</th>
          <th>Unique ID</th>
          <th>Name</th>
          <th>Number</th>
          <th>Description</th>
          <th>LGA</th>
          <th>State</th>
        </tr>
      </thead>
      <tbody>
        {% for p in poll %}
        <tr>
          <td>{{forloop.counter}}</td>
          <td>{{p.uniqueid}}</td>
          <th scope="row" class="text-start">{{p.polling_unit_name}}</th>
          <td>{{p.polling_unit_number}}</td>
          <td>{{p.polling_unit_description}}</td>
          <td>{{p.lga_name}}</td>
          <td>{{p.state_name}}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="table-responsive">
    <table
      class="table table-striped table-hover"
      id="polling_unit_result_table"
    >
      <thead>
        <tr>
          <th style="width: 34%">#</th>
          <th style="width: 34%">Party Abbreviation</th>
          <th style="width: 22%">Party Score</th>
        </tr>
      </thead>
      <tbody>
        {% for r in result_poll %}
        <tr>
          <td>{{forloop.counter}}</td>
          <td>{{r.party_abbreviation}}</td>
          <td>{{r.party_score}}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</main>

{% endblock content %}

<!---->
{% block js %}
<script>
  $(document).ready(function () {
    const pollingUnitNumber = document.getElementById("polling_unit_number");
    const pollingUnitInfoTable = document.getElementById(
      "polling_unit_info_table"
    );
    const pollingUnitResultTable = document.getElementById(
      "polling_unit_result_table"
    );
    pollingUnitNumber.addEventListener("keyup", (e) => {
      e.preventDefault();
      pollingUnitInfoTable.innerHTML = "";
      pollingUnitResultTable.innerHTML = "";
      const pUnitNumber = e.target.value.toUpperCase();
      let formData = new FormData();
      formData.append("unit_number", pUnitNumber);
      $.ajax({
        url: "{% url 'elections:pulling_unit_result' %}",
        type: "POST",
        dataType: "json",
        cache: false,
        processData: false,
        contentType: false,
        data: formData,
        error: function (xhr) {
          console.error(xhr.statusText);
        },
        success: function (res) {
          console.log(res);
          if (!res.success) {
            if (!document.getElementById("spinningLoader")) {
              $("#polling_unit_info_header").text(res.msg);
            }
          } else {
            if (res.poll_info.length > 0) {
              $("#polling_unit_info_header").text("Polling unit information");

              pollingUnitInfoTable.innerHTML = `
                    <thead>
                      <tr>
                        <th>#</th>
                        <th>Unique ID</th>
                        <th>Name</th>
                        <th>Number</th>
                        <th>Description</th>
                        <th>LGA</th>
                        <th>State</th>
                      </tr>
                    </thead>
                    <tbody>`;
              let counter = 1;
              res.poll_info.forEach((p) => {
                pollingUnitInfoTable.innerHTML += `
                    <tr>
                      <td>${counter}</td>
                      <td>${p.uniqueid}</td>
                      <th scope="row" class="text-start">${p.polling_unit_name}</th>
                      <td>${p.polling_unit_number}</td>
                      <td>${p.polling_unit_description}</td>
                      <td>${p.lga_name}</td>
                      <td>${p.state_name}</td>
                    </tr>`;
                counter++;
              });
              pollingUnitInfoTable.innerHTML += `</tbody>`;
            } else {
              if (!document.getElementById("spinningLoader")) {
                pollingUnitInfoTable.innerHTML = `<h3 class="text-center">No information available for this query</h3>`;
              }
            }

            if (res.polling_unit_result.length > 0) {
              pollingUnitResultTable.innerHTML = `
                  <thead>
                    <tr>
                      <th style="width: 34%">#</th>
                      <th style="width: 34%">Party Abbreviation</th>
                      <th style="width: 22%">Party Score</th>
                    </tr>
                  </thead>
                  <tbody>
                  `;
              let counter2 = 1;
              res.polling_unit_result.forEach((r) => {
                pollingUnitResultTable.innerHTML += `
                    <tr>
                      <td>${counter2}</td>
                      <td>${r.party_abbreviation}</td>
                      <td>${r.party_score}</td>
                    </tr>`;
                counter2++;
              });
              pollingUnitResultTable.innerHTML += `</tbody>`;
            } else {
              if (!document.getElementById("spinningLoader")) {
                pollingUnitResultTable.innerHTML = `<h3 class="text-center">No result available for this query</h3>`;
              }
            }
          }
        },
      });
    });
  });
</script>
{% endblock js %}
